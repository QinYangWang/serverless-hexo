AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Parameters:
  Prefix:
    Type: String
    Description: Resource name prefix.
  Env:
    Type: String
    Description: Resource deployment environment.
Resources:
  #######################################
  # Blog static file storage S3 bucket
  #######################################
  StaticBucketResource:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub ${Prefix}-${Env}-static
  #######################################
  # Blog static file CloudFront CDN
  #######################################
    CloudFrontOriginAccessIdentity:
        Type: "AWS::CloudFront::CloudFrontOriginAccessIdentity"
        Properties:
            CloudFrontOriginAccessIdentityConfig:
                Comment: !Ref StaticBucketResource
    ReadPolicy:
        Type: "AWS::S3::BucketPolicy"
        Properties:
            Bucket: !Ref StaticBucketResource
            PolicyDocument:
                Statement:
                    - Action: "s3:GetObject"
                      Effect: Allow
                      Resource:
                          - !Sub "${StaticBucketResource.Arn}"
                          - !Sub "${StaticBucketResource.Arn}/*"
                      Principal:
                          CanonicalUser: !GetAtt CloudFrontOriginAccessIdentity.S3CanonicalUserId
    CloudFrontDistribution:
        Type: "AWS::CloudFront::Distribution"
        Properties:
            DistributionConfig:
                CustomErrorResponses:
                    - ErrorCode: 403
                      ResponseCode: 404
                      ResponsePagePath: !Ref ErrorPagePath
                DefaultCacheBehavior:
                    AllowedMethods:
                        - GET
                        - HEAD
                        - OPTIONS
                    CachedMethods:
                        - GET
                        - HEAD
                        - OPTIONS
                    Compress: true
                    DefaultTTL: 3600
                    ForwardedValues:
                        Cookies:
                            Forward: none
                        QueryString: false
                    MaxTTL: 86400
                    MinTTL: 60
                    TargetOriginId: s3origin
                    ViewerProtocolPolicy: redirect-to-https
                DefaultRootObject: "index.html"
                Enabled: true
                HttpVersion: http2
                Origins:
                    - DomainName: !GetAtt StaticBucketResource.DomainName
                      Id: s3origin
                      S3OriginConfig:
                          OriginAccessIdentity: !Sub >-
                              origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}
                PriceClass: PriceClass_All
  #######################################
  # Blog static file generate lambda layer 
  #######################################
  HexoLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      Description: hexo and hexo plugin
      ContentUri: layers/hexo
      CompatibleRuntimes:
        - nodejs20.x
      RetentionPolicy: Delete
    Metadata:
      BuildMethod: nodejs20.x
  #######################################
  # Blog static file generate lambda 
  #######################################
  StaticGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${Prefix}-${Env}-static-lambda"
      CodeUri: functions/staticgenerator
      Handler: app.handler
      Runtime: nodejs20.x
      Architectures:
        - x86_64
      Layers:
        - !Ref HexoLayer
        - !Sub arn:aws:lambda:${AWS::Region}:553035198032:layer:git-lambda2:8
      Timeout: 300
      Environment:
        Variables:
          BUCKET_NAME: !Ref StaticBucketResource